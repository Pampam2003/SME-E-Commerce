<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | SME E-Commerce</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin:0; padding:30px; min-height:100vh; }
  .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
  h2 { text-align:center; margin-bottom:20px; color:#2c3e50; font-size:32px; font-weight:700; }
  table { width:100%; border-collapse: collapse; margin:30px 0; border-radius:12px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.1); }
  th { background: linear-gradient(to right, #6366f1, #8b5cf6); color:white; padding:20px; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
  td { padding:18px; text-align:center; border-bottom:1px solid #eee; font-size:16px; }
  tr:hover { background:#f8faff; }
  input { padding:14px; width:100%; border:2px solid #e2e8f0; border-radius:12px; font-size:16px; }
  input:focus { border-color:#6366f1; outline:none; }
  button { padding:16px 32px; border:none; border-radius:12px; background: linear-gradient(to right, #10b981, #34d399); color:white; font-weight:bold; font-size:18px; cursor:pointer; box-shadow:0 8px 20px rgba(16,185,129,0.3); }
  button:hover { transform:translateY(-3px); box-shadow:0 12px 30px rgba(16,185,129,0.4); }
  .back-btn { background: linear-gradient(to right, #6366f1, #8b5cf6); margin-bottom:20px; }
  .status { text-align:center; margin:25px 0; padding:20px; border-radius:16px; font-weight:700; font-size:20px; }
  .status.success { background:#d1fae5; color:#065f46; }
  .status.error { background:#fee2e2; color:#991b1b; }
  .total { font-size:32px; font-weight:bold; text-align:center; color:#10b981; margin:30px 0; }
</style>
</head>
<body>

<div class="container">
  <h2>Checkout</h2>
  <button class="back-btn" onclick="window.history.back()">Back to Shopping</button>

  <table id="cartTable">
    <thead>
      <tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="total">Grand Total: KSh <span id="grandTotal">0</span></div>

  <h3>Customer Information</h3>
  <div style="max-width:500px; margin:0 auto 40px;">
    <label>Email:</label><br>
    <input type="email" id="email" readonly><br><br>
    <label>Phone (M-Pesa):</label><br>
    <input type="tel" id="phone" placeholder="254712345678" maxlength="12"><br><br>
  </div>

  <div style="text-align:center;">
    <button id="checkoutBtn">Place Order & Pay with M-Pesa</button>
  </div>
  <div class="status" id="status"></div>
</div>

<script>
// UNKILLABLE USER SYSTEM
let user = null;
const keys = ['currentUser', 'user', 'checkoutUser', 'ordersUser'];
for (const key of keys) {
  try {
    const data = localStorage.getItem(key);
    if (data) {
      const u = JSON.parse(data);
      if (u && u.email) {
        user = u;
        keys.forEach(k => localStorage.setItem(k, JSON.stringify(user)));
        break;
      }
    }
  } catch(e) {}
}
if (!user || !user.email) {
  alert('Session expired!');
  window.location.href = 'customer.html';
}

// Keep alive
setInterval(() => keys.forEach(k => localStorage.setItem(k, JSON.stringify(user))), 30000);

document.getElementById('email').value = user.email;

const cart = JSON.parse(localStorage.getItem('cart') || '[]');
let grandTotal = 0;

function loadCart() {
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';
  grandTotal = 0;

  if (cart.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="padding:60px;color:#94a3b8;">Cart is empty</td></tr>';
    document.getElementById('grandTotal').textContent = '0';
    return;
  }

  cart.forEach(item => {
    const total = item.price * item.qty;
    grandTotal += total;
    tbody.innerHTML += `
      <tr>
        <td><strong>${item.name}</strong></td>
        <td>KSh ${Number(item.price).toFixed(2)}</td>
        <td>${item.qty}</td>
        <td><strong>KSh ${total.toFixed(2)}</strong></td>
      </tr>
    `;
  });
  document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}
loadCart();

// FINAL PAYMENT FLOW — 100% SUCCESS GUARANTEED
async function placeOrder() {
  if (cart.length === 0) return alert('Cart is empty!');

  const phone = document.getElementById('phone').value.trim();
  if (!/^254[17]\d{8}$/.test(phone)) {
    return alert('Enter valid phone: 254712345678');
  }

  const statusEl = document.getElementById('status');
  statusEl.innerHTML = '<div class="status">Creating order...</div>';

  try {
    // 1. CREATE ORDER
    const orderRes = await fetch('http://localhost:5000/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: user.email,
        cart: cart.map(i => ({ id: i.id, qty: i.qty, price: i.price })),
        phone: phone
      })
    });

    const orderData = await orderRes.json();
    if (!orderRes.ok) throw new Error(orderData.message || 'Order failed');

    const orderId = orderData.order_id;
    if (!orderId) throw new Error('No order ID');

    statusEl.innerHTML = '<div class="status success">Order placed! Sending M-Pesa prompt...</div>';

    // 2. TRIGGER STK PUSH
    const mpesaRes = await fetch('http://localhost:5000/mpesa/stkpush', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        phone: phone,
        amount: Math.round(grandTotal),
        order_id: orderId
      })
    });

    const mpesaData = await mpesaRes.json();
    if (!mpesaRes.ok) throw new Error(mpesaData.error || 'Payment failed');

    statusEl.innerHTML = `
      <div class="status success">
        <strong>M-Pesa prompt sent!</strong><br>
        Check your phone & enter PIN<br>
        <small>Waiting for payment...</small>
      </div>
    `;

    // 3. POLL UNTIL PAID — THEN REDIRECT TO ORDERS
    let attempts = 0;
    const poll = setInterval(async () => {
      attempts++;
      try {
        const res = await fetch(`http://localhost:5000/orders/${orderId}`);
        const data = await res.json();

        if (data.status === 'Paid') {
          clearInterval(poll);
          statusEl.innerHTML = `
            <div class="status success" style="font-size:24px;padding:30px;">
              <strong>PAYMENT SUCCESSFUL!</strong><br><br>
              Order #${orderId} is now PAID<br>
              Redirecting to your orders...
            </div>
          `;
          localStorage.removeItem('cart');
          localStorage.setItem('justPaidOrder', orderId); // So orders page knows to highlight it
          
          setTimeout(() => {
            window.location.href = 'orders.html';
          }, 3000);
        } else if (attempts > 60) { // 3 minutes max
          clearInterval(poll);
          statusEl.innerHTML = '<div class="status error">Payment timeout. Check your phone or try again.</div>';
        }
      } catch(e) {
        if (attempts > 60) {
          clearInterval(poll);
          statusEl.innerHTML = '<div class="status error">Connection lost. Please check Orders page.</div>';
        }
      }
    }, 5000); // Check every 5 seconds

  } catch (err) {
    statusEl.innerHTML = `<div class="status error">Error: ${err.message}</div>`;
  }
}

document.getElementById('checkoutBtn').onclick = placeOrder;
</script>
</body>
</html>
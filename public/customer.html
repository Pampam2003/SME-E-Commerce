<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SME E-Commerce | Shop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      color: #333;
    }
    .container { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: #2c3e50;
      color: white;
      padding: 25px 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .logo {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      margin-bottom:nienie 40px;
      color: #1abc9c;
    }
    nav ul { list-style: none; }
    nav ul li { margin: 12px 0; }
    nav a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 14px 18px;
      border-radius: 8px;
      font-size: 16px;
      transition: 0.3s;
    }
    nav a:hover, nav a.active {
      background: #34495e;
      transform: translateX(5px);
    }
    .main { 
      flex: 1; 
      padding: 30px; 
      margin-left: 260px;
      overflow-y: auto; 
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .page-title { font-size: 24px; font-weight: 600; color: #2c3e50; }

    .section { display: none; }
    .section.active { display: block; }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-bar select,
    .search-bar input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .search-bar select { width: 180px; }
    .search-bar input { flex: 1; min-width: 200px; }
    .search-bar button {
      padding: 10px 20px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .search-bar button:hover { background: #2980b9; }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      text-align: center;
      transition: 0.3s;
    }
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }
    .product-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .product-info { padding: 16px; }
    .product-info h3 { font-size: 17px; margin-bottom: 8px; color: #2c3e50; }
    .product-info p { font-size: 14px; color: #7f8c8d; margin: 4px 0; }
    .price { font-weight: bold; color: #27ae60; font-size: 19px; }
    .stock { font-size: 13px; color: #e67e22; }
    .add-to-cart {
      margin-top: 12px;
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
    }
    .add-to-cart:hover { background: #2980b9; }

    /* Orders Table */
    .orders-table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .orders-table th, .orders-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .orders-table th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }
    .status-flow {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      flex-wrap: wrap;
    }
    .status-paid { color: #27ae60; }
    .status-shipped { color: #3498db; }
    .status-delivered { color: #9b59b6; }
    .status-pending { color: #e67e22; }
    .arrow { color: #bdc3c7; font-size: 18px; }

    .review-btn {
      background: #9b59b6;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .review-btn:hover { background: #8e44ad; }

    .cart-table { width: 100%; background: white; border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-top: 20px; }
    .cart-table th, .cart-table td { padding: 14px; text-align: left; border-bottom: 1px solid #eee; }
    .cart-table th { background: #f8f9fa; }
    .remove-btn { background: #e74c3c; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .checkout-btn { margin-top: 20px; padding: 14px 30px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }

    .review-form {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .review-form select, .review-form input, .review-form textarea {
      width: 100%;
      padding: 12px;
      margin: 12px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .submit-review {
      background: #3498db;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .empty { text-align: center; color: #7f8c8d; padding: 60px 20px; font-size: 18px; }
    .loading { text-align: center; padding: 40px; color: #3498db; }

    .logout-container {
      text-align: center;
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #34495e;
    }
    .logout-btn {
      background: #e74c3c;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .logout-btn:hover { background: #c0392b; }
  </style>
</head>
<body>

  <div class="container">
    <aside class="sidebar">
      <div class="logo">SME Shop</div>
      <nav>
        <ul>
          <li><a href="#" data-section="products" class="active">All Products</a></li>
          <li><a href="#" data-section="cart">Cart (<span id="cartCount">0</span>)</a></li>
          <li><a href="orders.html">My Orders</a></li>
          <li><a href="#" data-section="reviews">Reviews & Ratings</a></li>
        </ul>
      </nav>
      <div class="logout-container">
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <h1 class="page-title" id="pageTitle">All Products</h1>
      </div>

      <!-- PRODUCTS -->
      <section id="products" class="section active">
        <div class="search-bar">
          <select id="categoryFilter">
            <option value="">All Categories</option>
            <option>Electronics</option>
            <option>Fashion & Beauty</option>
            <option>Food & Drinks</option>
            <option>Home & Living</option>
            <option>Health</option>
            <option>Services</option>
            <option>Other</option>
          </select>
          <input type="text" id="keywordSearch" placeholder="Search products..." />
          <button onclick="searchProducts()">Search</button>
        </div>
        <div id="products-loading" class="loading">Loading products...</div>
        <div id="productGrid" class="product-grid"></div>
      </section>

      <!-- CART -->
      <section id="cart" class="section">
        <div id="cart-empty" class="empty">Your cart is empty.</div>
        <table id="cart-table" class="cart-table" style="display:none;">
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="checkout-section" style="text-align:right;display:none;">
          <button class="checkout-btn" onclick="goToCheckout()">Proceed to Checkout</button>
        </div>
      </section>

      <!-- MY ORDERS - NOW INSIDE DASHBOARD -->
      <section id="orders" class="section">
        <h2 style="margin-bottom:20px;color:#2c3e50;">My Orders</h2>
        <div id="ordersList">
          <div class="loading">Loading your orders...</div>
        </div>
      </section>

      <!-- REVIEWS -->
      <section id="reviews" class="section">
        <div class="review-form">
          <h3>Leave a Review</h3>
          <p>Only products marked as <strong>Delivered</strong> can be reviewed.</p>
          <select id="deliveredProducts">
            <option value="">Loading delivered products...</option>
          </select>
          <p>Rating (1-5 stars):</p>
          <input type="number" id="rating" min="1" max="5" placeholder="e.g. 5" />
          <p>Your Review:</p>
          <textarea id="reviewText" rows="5" placeholder="Share your experience..."></textarea>
          <button class="submit-review" onclick="submitReview()">Submit Review</button>
          <p style="margin-top:15px;color:#7f8c8d;font-size:14px;">
            Thank you for shopping with us!
          </p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API = 'http://localhost:5000';
    let user = null;

    // Protected Access
    try {
      user = JSON.parse(localStorage.getItem('currentUser'));
    } catch (e) {}
    if (!user || !user.email) {
      alert('Please login first');
      window.location.href = 'login.html';
    }

    // Navigation
    document.querySelectorAll('.sidebar a[data-section]').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        const section = document.getElementById(link.dataset.section);
        section.classList.add('active');
        link.classList.add('active');
        document.getElementById('pageTitle').textContent = link.textContent.trim();
        loadSection(link.dataset.section);
      });
    });

    function loadSection(section) {
      if (section === 'products') loadProducts();
      if (section === 'cart') loadCart();
      if (section === 'orders') loadCustomerOrders();
      if (section === 'reviews') loadDeliveredProductsForReview();
    }

    // Load Products
    async function loadProducts() {
      const grid = document.getElementById('productGrid');
      const loading = document.getElementById('products-loading');
      try {
        const res = await fetch(`${API}/products`);
        const products = await res.json();
        displayProducts(products);
        loading.style.display = 'none';
      } catch (err) {
        grid.innerHTML = '<p class="empty">Failed to load products.</p>';
      }
    }

    function displayProducts(products) {
      const grid = document.getElementById('productGrid');
      if (!products.length) {
        grid.innerHTML = '<p class="empty">No products available.</p>';
        return;
      }
      grid.innerHTML = products.map(p => `
        <div class="product-card">
          ${p.image ? `<img src="${API}${p.image}" alt="${p.name}">` : '<div style="height:180px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;">No Image</div>'}
          <div class="product-info">
            <h3>${p.name}</h3>
            <p>${p.category || 'Uncategorized'}</p>
            <p class="price">KSh ${Number(p.price).toLocaleString()}</p>
            <p class="stock">Stock: ${p.quantity > 0 ? p.quantity + ' left' : 'Out of stock'}</p>
            <button class="add-to-cart" ${p.quantity === 0 ? 'disabled' : ''} onclick="addToCart(${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price})">
              ${p.quantity === 0 ? 'Out of Stock' : 'Add to Cart'}
            </button>
          </div>
        </div>
      `).join('');
    }

    function searchProducts() {
      const category = document.getElementById('categoryFilter').value;
      const keyword = document.getElementById('keywordSearch').value.trim().toLowerCase();
      loadProducts().then(() => {
        const all = document.querySelectorAll('.product-card');
        all.forEach(card => {
          const name = card.querySelector('h3').textContent.toLowerCase();
          const desc = card.querySelector('p').textContent.toLowerCase();
          const matchCat = !category || card.querySelector('p').textContent.includes(category);
          const matchKey = !keyword || name.includes(keyword) || desc.includes(keyword);
          card.style.display = matchCat && matchKey ? 'block' : 'none';
        });
      });
    }

    // Cart Functions
    function addToCart(id, name, price) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existing = cart.find(i => i.id === id);
      if (existing) existing.qty += 1;
      else cart.push({ id, name, price, qty: 1 });
      localStorage.setItem('cart', JSON.stringify(cart));
      alert(`${name} added to cart!`);
      updateCartCount();
    }

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const tbody = document.querySelector('#cart-table tbody');
      const empty = document.getElementById('cart-empty');
      const checkout = document.getElementById('checkout-section');

      if (!cart.length) {
        empty.style.display = 'block';
        document.getElementById('cart-table').style.display = 'none';
        checkout.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      document.getElementById('cart-table').style.display = 'table';
      checkout.style.display = 'block';

      tbody.innerHTML = cart.map(item => `
        <tr>
          <td>${item.name}</td>
          <td>KSh ${Number(item.price).toLocaleString()}</td>
          <td>${item.qty}</td>
          <td>KSh ${(item.price * item.qty).toLocaleString()}</td>
          <td><button class="remove-btn" onclick="removeFromCart(${item.id})">Remove</button></td>
        </tr>
      `).join('');
      updateCartCount();
    }

    window.removeFromCart = function(id) {
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart = cart.filter(i => i.id !== id);
      localStorage.setItem('cart', JSON.stringify(cart));
      loadCart();
    };

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const total = cart.reduce((s, i) => s + i.qty, 0);
      document.getElementById('cartCount').textContent = total;
    }

    function goToCheckout() {
      localStorage.setItem('checkoutUser', JSON.stringify(user));
      localStorage.setItem('checkoutCart', JSON.stringify(JSON.parse(localStorage.getItem('cart') || '[]')));
      window.location.href = 'checkout.html';
    }

    // MY ORDERS - WITH STATUS TRACKING
    async function loadCustomerOrders() {
      const container = document.getElementById('ordersList');
      try {
        const res = await fetch(`${API}/customer-orders?email=${user.email}`);
        const orders = await res.json();

        if (!orders.length) {
          container.innerHTML = '<p class="empty">No orders yet. Start shopping!</p>';
          return;
        }

        container.innerHTML = `
          <table class="orders-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(o => {
                const isPaid = ['Paid', 'Shipped', 'Delivered'].includes(o.status);
                const isShipped = ['Shipped', 'Delivered'].includes(o.status);
                const isDelivered = o.status === 'Delivered';

                return `
                  <tr>
                    <td><strong>#${o.order_id}</strong></td>
                    <td>${o.product_name}</td>
                    <td>${o.quantity}</td>
                    <td>KSh ${parseFloat(o.total_price).toLocaleString()}</td>
                    <td>${new Date(o.order_date).toLocaleDateString()}</td>
                    <td>
                      <div class="status-flow">
                        <span class="${isPaid ? 'status-paid' : 'status-pending'}">Paid</span>
                        <span class="arrow">${isPaid ? '→' : '—'}</span>
                        <span class="${isShipped ? 'status-shipped' : ''}">Shipped</span>
                        <span class="arrow">${isShipped ? '→' : '—'}</span>
                        <span class="${isDelivered ? 'status-delivered' : ''}">Delivered</span>
                        ${isDelivered ? '<span style="margin-left:10px;color:#27ae60;">Received</span>' : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        container.innerHTML = '<p class="empty">Failed to load orders.</p>';
      }
    }

    // Load Delivered Products for Review
    async function loadDeliveredProductsForReview() {
      const select = document.getElementById('deliveredProducts');
      try {
        const res = await fetch(`${API}/delivered-orders?email=${user.email}`);
        const products = await res.json();

        if (!products.length) {
          select.innerHTML = '<option value="">No delivered products to review yet</option>';
          return;
        }

        select.innerHTML = '<option value="">Select a product to review</option>' + 
          products.map(p => `<option value="${p.product_id}">${p.product_name} (#${p.order_id})</option>`).join('');
      } catch (err) {
        select.innerHTML = '<option value="">Error loading products</option>';
      }
    }

    async function submitReview() {
      const product_id = document.getElementById('deliveredProducts').value;
      const rating = document.getElementById('rating').value;
      const review = document.getElementById('reviewText').value.trim();

      if (!product_id || !rating || !review) {
        return alert('Please select a product, rating, and write a review.');
      }

      try {
        const res = await fetch(`${API}/review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id, customer_email: user.email, rating: Number(rating), review })
        });
        const data = await res.json();
        alert(data.message || 'Thank you for your review!');
        document.getElementById('reviewText').value = '';
        document.getElementById('rating').value = '';
        document.getElementById('deliveredProducts').selectedIndex = 0;
      } catch (err) {
        alert('Failed to submit review.');
      }
    }

    function logout() {
      if (confirm('Logout now?')) {
        localStorage.clear();
        window.location.href = 'login.html';
      }
    }

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      updateCartCount();
      loadProducts();
    });
  </script>
</body>
</html>